{% extends "base.html" %}
{% load static %}
{% block title %}Crear caso interesante{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Tarjeta de Datos del Paciente -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="card-title mb-0 text-center">Datos del Paciente</h2>
                </div>
                <div class="card-body text-center">
                    <p>Usted est√° registrando un nuevo caso para el paciente: <strong>{{ paciente.nombre }} {{ paciente.apellido }} (DNI: {{ paciente.dni }})</strong></p>
                </div>
            </div>

            <!-- Formulario de Caso Interesante -->
            <form method="post" enctype="multipart/form-data" class="row g-2">
                {% csrf_token %}

                <!-- Datos del Caso -->
                <div class="card mb-4 p-0">
                    <div class="card-header bg-primary text-white">
                        <h2 class="card-title mb-0 text-center w-100">Datos del Caso</h2>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.id_estudio.id_for_label }}" class="form-label">{{ form.id_estudio.label }}</label>
                                {{ form.id_estudio }}
                                {% if form.id_estudio.errors %}
                                    <div class="text-danger">{{ form.id_estudio.errors }}</div>
                                {% endif %}
                                {% if form.id_estudio.help_text %}
                                    <div class="form-text text-muted">{{ form.id_estudio.help_text }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mt-3 mt-md-0">
                                <label for="{{ form.sede.id_for_label }}" class="form-label">{{ form.sede.label }}</label>
                                {{ form.sede }}
                                {% if form.sede.errors %}
                                    <div class="text-danger">{{ form.sede.errors }}</div>
                                {% endif %}
                                {% if form.sede.help_text %}
                                    <div class="form-text text-muted">{{ form.sede.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.fecha.id_for_label }}" class="form-label">{{ form.fecha.label }}</label>
                                {{ form.fecha }}
                                {% if form.fecha.errors %}
                                    <div class="text-danger">{{ form.fecha.errors }}</div>
                                {% endif %}
                                {% if form.fecha.help_text %}
                                    <div class="form-text text-muted">{{ form.fecha.help_text }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mt-3 mt-md-0">
                                <label for="{{ form.tipo_estudio.id_for_label }}" class="form-label">{{ form.tipo_estudio.label }}</label>
                                {{ form.tipo_estudio }}
                                {% if form.tipo_estudio.errors %}
                                    <div class="text-danger">{{ form.tipo_estudio.errors }}</div>
                                {% endif %}
                                {% if form.tipo_estudio.help_text %}
                                    <div class="form-text text-muted">{{ form.tipo_estudio.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.contraste_ev }}
                                    <label class="form-check-label" for="{{ form.contraste_ev.id_for_label }}">
                                        {{ form.contraste_ev.label }}
                                    </label>
                                    {% if form.contraste_ev.errors %}
                                        <div class="text-danger">{{ form.contraste_ev.errors }}</div>
                                    {% endif %}
                                    {% if form.contraste_ev.help_text %}
                                        <div class="form-text text-muted">{{ form.contraste_ev.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    {{ form.contraste_or }}
                                    <label class="form-check-label" for="{{ form.contraste_or.id_for_label }}">
                                        {{ form.contraste_or.label }}
                                    </label>
                                    {% if form.contraste_or.errors %}
                                        <div class="text-danger">{{ form.contraste_or.errors }}</div>
                                    {% endif %}
                                    {% if form.contraste_or.help_text %}
                                        <div class="form-text text-muted">{{ form.contraste_or.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.region_anatomica.id_for_label }}" class="form-label">{{ form.region_anatomica.label }}</label>
                                {{ form.region_anatomica }}
                                {% if form.region_anatomica.errors %}
                                    <div class="text-danger">{{ form.region_anatomica.errors }}</div>
                                {% endif %}
                                {% if form.region_anatomica.help_text %}
                                    <div class="form-text text-muted">{{ form.region_anatomica.help_text }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.sistema.id_for_label }}" class="form-label">{{ form.sistema.label }}</label>
                                {{ form.sistema }}
                                {% if form.sistema.errors %}
                                    <div class="text-danger">{{ form.sistema.errors }}</div>
                                {% endif %}
                                {% if form.sistema.help_text %}
                                    <div class="form-text text-muted">{{ form.sistema.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.organo.id_for_label }}" class="form-label">{{ form.organo.label }}</label>
                                {{ form.organo }}
                                {% if form.organo.errors %}
                                    <div class="text-danger">{{ form.organo.errors }}</div>
                                {% endif %}
                                {% if form.organo.help_text %}
                                    <div class="form-text text-muted">{{ form.organo.help_text }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.especialidad.id_for_label }}" class="form-label">{{ form.especialidad.label }}</label>
                                {{ form.especialidad }}
                                {% if form.especialidad.errors %}
                                    <div class="text-danger">{{ form.especialidad.errors }}</div>
                                {% endif %}
                                {% if form.especialidad.help_text %}
                                    <div class="form-text text-muted">{{ form.especialidad.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-12">
                                <label for="{{ form.descripcion.id_for_label }}" class="form-label">{{ form.descripcion.label }}</label>
                                {{ form.descripcion }}
                                {% if form.descripcion.errors %}
                                    <div class="text-danger">{{ form.descripcion.errors }}</div>
                                {% endif %}
                                {% if form.descripcion.help_text %}
                                    <div class="form-text text-muted">{{ form.descripcion.help_text }}</div>
                                {% endif %}
                            </div>
                            <div class="col-12 mt-4">
                                <label for="{{ form.hallazgos.id_for_label }}" class="form-label">{{ form.hallazgos.label }}</label>
                                {{ form.hallazgos }}
                                {% if form.hallazgos.errors %}
                                    <div class="text-danger">{{ form.hallazgos.errors }}</div>
                                {% endif %}
                                {% if form.hallazgos.help_text %}
                                    <div class="form-text text-muted">{{ form.hallazgos.help_text }}</div>
                                {% endif %}
                            </div>
                            <div class="col-12 mt-4">
                                <label for="{{ form.fragmento_informe.id_for_label }}" class="form-label">{{ form.fragmento_informe.label }}</label>
                                {{ form.fragmento_informe }}
                                {% if form.fragmento_informe.errors %}
                                    <div class="text-danger">{{ form.fragmento_informe.errors }}</div>
                                {% endif %}
                                {% if form.fragmento_informe.help_text %}
                                    <div class="form-text text-muted">{{ form.fragmento_informe.help_text }}</div>
                                {% endif %}
                            </div>
                            <div class="col-12 mt-4">
                                <label for="{{ form.etiquetas.id_for_label }}" class="form-label">{{ form.etiquetas.label }}</label>
                                {{ form.etiquetas }}
                                {% if form.etiquetas.errors %}
                                    <div class="text-danger">{{ form.etiquetas.errors }}</div>
                                {% endif %}
                                {% if form.etiquetas.help_text %}
                                    <div class="form-text text-muted">{{ form.etiquetas.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cargar Im√°genes -->
                <div class="card mb-4 p-0">
                    <div class="card-header bg-primary text-white">
                        <h2 class="card-title mb-0 text-center w-100">Im√°genes del Caso</h2>
                    </div>
                    <div class="card-body">
                        <div id="file-fields-container" class="form-group">
                            <div class="input-group mb-3">
                                <input type="file" name="imagenes" class="form-control">
                                <button type="button" class="btn btn-outline-secondary remove-file-field">Eliminar</button>
                            </div>
                            {% if form.imagenes.errors %}
                                <div class="text-danger">{{ form.imagenes.errors }}</div>
                            {% endif %}
                            {% if form.imagenes.help_text %}
                                <div class="form-text text-muted">{{ form.imagenes.help_text }}</div>
                            {% endif %}
                        </div>
                        <button type="button" id="add-more-files" class="btn btn-secondary mt-3">Agregar otra imagen</button>
                    </div>
                </div>

                 <!-- Bot√≥n de guardar y cancelar al mismo nivel -->
                <div class="d-flex justify-content-between mt-3">
                    <a href="{% url 'home' %}" class="btn btn-secondary">Cancelar</a>
                    <button type="submit" class="btn btn-primary">Guardar Caso</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.getElementById('add-more-files').addEventListener('click', function () {
        var container = document.getElementById('file-fields-container');
        var newFieldGroup = document.createElement('div');
        newFieldGroup.className = 'input-group mb-3';
        
        var newField = document.createElement('input');
        newField.type = 'file';
        newField.name = 'imagenes';
        newField.className = 'form-control';
        
        var removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.className = 'btn btn-outline-secondary remove-file-field';
        removeButton.textContent = 'Eliminar';
        
        newFieldGroup.appendChild(newField);
        newFieldGroup.appendChild(removeButton);
        container.appendChild(newFieldGroup);
    });

    document.addEventListener('click', function (e) {
        if (e.target && e.target.classList.contains('remove-file-field')) {
            var fileFieldsContainer = document.getElementById('file-fields-container');
            var fileFieldGroups = fileFieldsContainer.getElementsByClassName('input-group');
            
            if (fileFieldGroups.length > 1) {
                e.target.parentElement.remove();
            } else {
                var inputField = e.target.previousElementSibling;
                if (inputField) {
                    inputField.value = '';
                }
            }
        }
    });
</script>
{% endblock %}
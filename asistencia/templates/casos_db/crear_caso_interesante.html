{% extends "base.html" %}
{% load static %}
{% block title %}Crear caso interesante{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <form method="post" enctype="multipart/form-data" class="row g-2">
        {% csrf_token %}

        <!-- Datos del Paciente -->
        <div class="card mb-4">
            <div class="card-body row g-2">
                <h5 class="card-title">Datos del paciente</h5>
                <div class="col-md-4">
                    <label for="dni" class="form-label">DNI</label>
                    <input type="text" id="dni" name="dni" class="form-control">
                    <button type="button" id="buscar-dni" class="btn btn-secondary mt-2">Buscar</button>
                    <div id="dni-error" class="text-danger"></div>
                </div>
                <div class="col-md-4">
                    <label for="nombre" class="form-label">Nombre</label>
                    <input type="text" id="nombre" name="nombre" class="form-control">
                </div>
                <div class="col-md-4">
                    <label for="apellido" class="form-label">Apellido</label>
                    <input type="text" id="apellido" name="apellido" class="form-control">
                </div>
            </div>
        </div>
        
        <!-- Datos del Caso -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Datos del caso</h5>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.id_estudio.id_for_label }}" class="form-label">{{ form.id_estudio.label }}</label>
                        {{ form.id_estudio }}
                        {% if form.id_estudio.errors %}
                            <div class="text-danger">{{ form.id_estudio.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.sede.id_for_label }}" class="form-label">{{ form.sede.label }}</label>
                        {{ form.sede }}
                        {% if form.sede.errors %}
                            <div class="text-danger">{{ form.sede.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-auto">
                        <label for="{{ form.fecha.id_for_label }}" class="form-label">{{ form.fecha.label }}</label>
                        {{ form.fecha }}
                        {% if form.fecha.errors %}
                            <div class="text-danger">{{ form.fecha.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.tipo_estudio.id_for_label }}" class="form-label">{{ form.tipo_estudio.label }}</label>
                        {{ form.tipo_estudio }}
                        {% if form.tipo_estudio.errors %}
                            <div class="text-danger">{{ form.tipo_estudio.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Contraste -->
                <div class="row mb-3">
                    <div class="col-auto">
                        <div class="form-check">
                            {{ form.contraste_ev }}
                            <label class="form-check-label" for="{{ form.contraste_ev.id_for_label }}">
                                {{ form.contraste_ev.label }}
                            </label>
                            {% if form.contraste_ev.errors %}
                                <div class="text-danger">{{ form.contraste_ev.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="form-check">
                            {{ form.contraste_or }}
                            <label class="form-check-label" for="{{ form.contraste_or.id_for_label }}">
                                {{ form.contraste_or.label }}
                            </label>
                            {% if form.contraste_or.errors %}
                                <div class="text-danger">{{ form.contraste_or.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.region_anatomica.id_for_label }}" class="form-label">{{ form.region_anatomica.label }}</label>
                        {{ form.region_anatomica }}
                        {% if form.region_anatomica.errors %}
                            <div class="text-danger">{{ form.region_anatomica.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.sistema.id_for_label }}" class="form-label">{{ form.sistema.label }}</label>
                        {{ form.sistema }}
                        {% if form.sistema.errors %}
                            <div class="text-danger">{{ form.sistema.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.organo.id_for_label }}" class="form-label">{{ form.organo.label }}</label>
                        {{ form.organo }}
                        {% if form.organo.errors %}
                            <div class="text-danger">{{ form.organo.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.especialidad.id_for_label }}" class="form-label">{{ form.especialidad.label }}</label>
                        {{ form.especialidad }}
                        {% if form.especialidad.errors %}
                            <div class="text-danger">{{ form.especialidad.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Descripción y Hallazgos -->
                <div class="row mb-3">
                    <div class="col-12">
                        <label for="{{ form.descripcion.id_for_label }}" class="form-label">{{ form.descripcion.label }}</label>
                        {{ form.descripcion }}
                        {% if form.descripcion.errors %}
                            <div class="text-danger">{{ form.descripcion.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12">
                        <label for="{{ form.hallazgos.id_for_label }}" class="form-label">{{ form.hallazgos.label }}</label>
                        {{ form.hallazgos }}
                        {% if form.hallazgos.errors %}
                            <div class="text-danger">{{ form.hallazgos.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12">
                        <label for="{{ form.fregmento_informe.id_for_label }}" class="form-label">{{ form.fregmento_informe.label }}</label>
                        {{ form.fregmento_informe }}
                        {% if form.fregmento_informe.errors %}
                            <div class="text-danger">{{ form.fregmento_informe.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12">
                        <label for="{{ form.etiquetas.id_for_label }}" class="form-label">{{ form.etiquetas.label }}</label>
                        {{ form.etiquetas }}
                        {% if form.etiquetas.errors %}
                            <div class="text-danger">{{ form.etiquetas.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Cargar Imágenes -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Imagen del caso</h5>
                {{ imagen_form.imagen }}
                {% if imagen_form.imagen.errors %}
                    <div class="text-danger">{{ imagen_form.imagen.errors }}</div>
                {% endif %}
            </div>
        </div>

        <!-- Botón de guardar -->
        <div class="text-end">
            <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
    </form>
</div>
<script>
    document.getElementById('buscar-dni').addEventListener('click', function () {
        var dni = document.getElementById('dni').value;
        var errorDiv = document.getElementById('dni-error');
        errorDiv.textContent = '';

        if (dni) {
            fetch(`/casos_interesantes_db/buscar_paciente/?dni=${dni}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        errorDiv.textContent = data.error;
                    } else {
                        document.getElementById('nombre').value = data.nombre;
                        document.getElementById('apellido').value = data.apellido;
                    }
                })
                .catch(error => {
                    errorDiv.textContent = 'Error al buscar el paciente';
                });
        } else {
            errorDiv.textContent = 'Por favor, ingrese un DNI';
        }
    });
</script>
{% endblock %}